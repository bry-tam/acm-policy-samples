---
object-templates-raw: |
  {{- range $mc := (lookup "cluster.open-cluster-management.io/v1" "ManagedCluster" "" "" "label=value").items }}
    {{- $mc_name := (printf "fozzie-msa-%s" $mc.metadata.name) }}


  - complianceType: musthave
    objectDefinition:
      apiVersion: authentication.open-cluster-management.io/v1beta1
      kind: ManagedServiceAccount
      metadata:
        name: '{{ $mc_name }}'
        namespace: '{{ $mc.metadata.name }}'
        labels:
          argo-msa: team-fozzie
      spec:
        rotation:
          enabled: true
          validity: 12h0m0s

  - complianceType: mustonlyhave
    objectDefinition:
      apiVersion: rbac.open-cluster-management.io/v1alpha1
      kind: ClusterPermission
      metadata:
        name: '{{ $mc_name }}'
        namespace: {{ $mc.metadata.name }}
      spec:
        roles:
        - namespace: app-team-fozzie
          rules:
          - apiGroups: ["apps"]
            resources: ["deployments"]
            verbs: ["get", "list", "create", "update", "delete", "patch"]
          - apiGroups: [""]
            resources: ["configmaps", "secrets", "pods", "podtemplates", "persistentvolumeclaims", "persistentvolumes"]
            verbs: ["get", "update", "list", "create", "delete", "patch"]
          - apiGroups: ["storage.k8s.io"]
            resources: ["*"]
            verbs: ["list"]
        clusterRole:
          rules:
          - apiGroups: [""]
            resources: ["namespaces"]
            resourceNames:
              - app-team-fozzie
            verbs: ["get", "update", "list", "create", "delete", "patch"]
        roleBindings:
        - namespace: app-team-fozzie
          roleRef:
            kind: Role
          subject:
            apiGroup: authentication.open-cluster-management.io
            kind: ManagedServiceAccount
            name: '{{ $mc_name }}'
        clusterRoleBinding:
          subject:
            apiGroup: authentication.open-cluster-management.io
            kind: ManagedServiceAccount
            name: '{{ $mc_name }}'
  {{- end }}
