---
object-templates-raw: |
  {{- range $mc := (lookup "cluster.open-cluster-management.io/v1" "ManagedCluster" "" "").items }}
    {{- $mc_name := (printf "scooter-msa-%s" $mc.metadata.name) }}


  - complianceType: musthave
    objectDefinition:
      apiVersion: authentication.open-cluster-management.io/v1beta1
      kind: ManagedServiceAccount
      metadata:
        name: '{{ $mc_name }}'
        namespace: '{{ $mc.metadata.name }}'
        labels:
          argo-msa: team-scooter
      spec:
        rotation:
          enabled: true
          validity: 12h0m0s

  - complianceType: mustonlyhave
    objectDefinition:
      apiVersion: rbac.open-cluster-management.io/v1alpha1
      kind: ClusterPermission
      metadata:
        name: '{{ $mc_name }}'
        namespace: {{ $mc.metadata.name }}
      spec:
        clusterRole:
          rules:
          - apiGroups:
              - templates.gatekeeper.sh
              - constraints.gatekeeper.sh
            resources:
              - '*'
            verbs:
              - '*'
        clusterRoleBinding:
          subject:
            apiGroup: authentication.open-cluster-management.io
            kind: ManagedServiceAccount
            name: '{{ $mc_name }}'
  {{- end }}
