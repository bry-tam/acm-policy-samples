---
apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: clusterlogging
spec:
  remediationAction: enforce
  severity: high
  object-templates-raw: |
    - complianceType: musthave
      objectDefinition:
        apiVersion: "observability.openshift.io/v1"
        kind: ClusterLogForwarder
        metadata:
          name: collector
          namespace: openshift-logging
        spec:
          serviceAccount:
            name: collector
          managementState: Managed
          collector:
            tolerations:
              - operator: Exists

          inputs:
            - name: infrastructure
              type: infrastructure
              infrastructure:
                sources: 
                  - node
                  - container
            - name: audit
              type: audit
              audit:
                sources: 
                  - kubeAPI
                  - openshiftAPI
                  - ovn
                  - auditd

          outputs:
          - name: default-lokistack
            type: lokiStack
            lokiStack:
              target:
                name: logging-loki
                namespace: openshift-logging
              authentication:
                token:
                  from: serviceAccount
            tls:
              ca:
                key: service-ca.crt
                configMapName: openshift-service-ca.crt

          pipelines:
          - name: default-logstore
            outputRefs:
            - default-lokistack
            inputRefs:
            - application
            - infrastructure
            - audit
            filterRefs: 
              - kubeapi-filter

          filters:
            - name: kubeapi-filter
              type: kubeAPIAudit
              kubeAPIAudit:
                # Don't generate audit events for all requests in RequestReceived stage.
                omitStages:
                  - "RequestReceived"

                rules:
                  # Log pod changes at RequestResponse level
                  - level: RequestResponse
                    resources:
                    - group: ""
                      resources: ["pods"]

                  # Log "pods/log", "pods/status" at Metadata level
                  - level: Metadata
                    resources:
                    - group: ""
                      resources: ["pods/log", "pods/status"]

                  # Don't log requests to a configmap called "controller-leader"
                  - level: None
                    resources:
                    - group: ""
                      resources: ["configmaps"]
                      resourceNames: ["controller-leader"]

                  # Don't log watch requests by the "system:kube-proxy" on endpoints or services
                  - level: None
                    users: ["system:kube-proxy"]
                    verbs: ["watch"]
                    resources:
                    - group: "" # core API group
                      resources: ["endpoints", "services"]

                  # Don't log authenticated requests to certain non-resource URL paths.
                  - level: None
                    userGroups: ["system:authenticated"]
                    nonResourceURLs:
                    - "/api*" # Wildcard matching.
                    - "/version"

                  # Log the request body of configmap changes in kube-system.
                  - level: Request
                    resources:
                    - group: "" # core API group
                      resources: ["configmaps"]
                    # This rule only applies to resources in the "kube-system" namespace.
                    # The empty string "" can be used to select non-namespaced resources.
                    namespaces: ["kube-system"]

                  # Log configmap and secret changes in all other namespaces at the Metadata level.
                  - level: Metadata
                    resources:
                    - group: "" # core API group
                      resources: ["secrets", "configmaps"]

                  # Log all other resources in core and extensions at the Request level.
                  - level: Request
                    resources:
                    - group: "" # core API group
                    - group: "extensions" # Version of group should NOT be included.

                  # A catch-all rule to log all other requests at the Metadata level.
                  - level: Metadata