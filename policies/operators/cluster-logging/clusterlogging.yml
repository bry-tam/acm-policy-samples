---
apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: clusterlogging
spec:
  remediationAction: enforce
  severity: high
  object-templates-raw: |
    - complianceType: mustonlyhave
      objectDefinition:
        apiVersion: "observability.openshift.io/v1"
        kind: ClusterLogForwarder
        metadata:
          annotations:
            observability.openshift.io/tech-preview-otlp-output: enabled
          name: collector
          namespace: openshift-logging
        spec:
          serviceAccount:
            name: collector
          managementState: Managed
          collector:
            tolerations:
              - operator: Exists

          inputs:
            - name: infrastructure
              type: infrastructure
              infrastructure:
                sources: 
                  - node
                  - container
            - name: audit
              type: audit
              audit:
                sources: 
                  - kubeAPI
                  - openshiftAPI
                  - ovn
                  - auditd

          outputs:
          - name: default-lokistack
            type: lokiStack
            lokiStack:
              dataModel: Otel
              target:
                name: logging-loki
                namespace: openshift-logging
              authentication:
                token:
                  from: serviceAccount
            tls:
              ca:
                key: service-ca.crt
                configMapName: openshift-service-ca.crt


          - name: otlp-loki-route-app
            type: otlp
            otlp:
              tuning:
                compression: gzip
                deliveryMode: AtLeastOnce
                maxRetryDuration: 20
                maxWrite: 32M
                minRetryDuration: 5
              url: https://logging-loki-openshift-logging.apps.acm.sandbox3288.opentlc.com/api/logs/v1/application/otlp/v1/logs
              authentication:
                token:
                  from: secret
                  secret:
                    key: token
                    name: collector-token


          - name: otlp-loki-route-infra
            type: otlp
            otlp:
              tuning:
                compression: gzip
                deliveryMode: AtLeastOnce
                maxRetryDuration: 20
                maxWrite: 32M
                minRetryDuration: 5
              url: https://logging-loki-openshift-logging.apps.acm.sandbox3288.opentlc.com/api/logs/v1/infrastructure/otlp/v1/logs
              authentication:
                token:
                  from: secret
                  secret:
                    key: token
                    name: collector-token


          - name: otlp-loki-route-audit
            type: otlp
            otlp:
              tuning:
                compression: gzip
                deliveryMode: AtLeastOnce
                maxRetryDuration: 20
                maxWrite: 32M
                minRetryDuration: 5
              url: https://logging-loki-openshift-logging.apps.acm.sandbox3288.opentlc.com/api/logs/v1/audit/otlp/v1/logs
              authentication:
                token:
                  from: secret
                  secret:
                    key: token
                    name: collector-token


          pipelines:
          - name: app-logstore
            outputRefs:
            - otlp-loki-route-app
            inputRefs:
            - application

          - name: infra-logstore
            outputRefs:
            - otlp-loki-route-infra
            inputRefs:
            - infrastructure


          - name: audit-logstore
            outputRefs:
            - otlp-loki-route-audit
            inputRefs:
            - audit
            filterRefs: 
              - kubeapi-filter

          filters:
            - name: kubeapi-filter
              type: kubeAPIAudit
              kubeAPIAudit:
                # Don't generate audit events for all requests in RequestReceived stage.
                omitStages:
                  - "RequestReceived"
