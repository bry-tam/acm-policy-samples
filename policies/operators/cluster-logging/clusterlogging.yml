---
apiVersion: "observability.openshift.io/v1"
kind: ClusterLogForwarder
metadata:
  annotations:
    observability.openshift.io/tech-preview-otlp-output: enabled
  name: collector
  namespace: openshift-logging
spec:
  serviceAccount:
    name: collector
  managementState: Managed
  collector:
    tolerations:
      - operator: Exists
    resources:
      requests:
        memory: 64Mi
        cpu: 250m


  inputs:
    - name: infrastructure
      type: infrastructure
      infrastructure:
        sources:
          - node
          - container
    - name: audit
      type: audit
      audit:
        sources:
          - kubeAPI
          - openshiftAPI
          - ovn
          - auditd

  outputs:
  - name: default-lokistack
    type: lokiStack
    lokiStack:
      dataModel: Otel
      target:
        name: logging-loki
        namespace: openshift-logging
      authentication:
        token:
          from: serviceAccount
    tls:
      ca:
        key: service-ca.crt
        configMapName: openshift-service-ca.crt


  pipelines:
  - name: default-logstore
    outputRefs:
      - default-lokistack
    inputRefs:
      - application
      - infrastructure
      - audit
    filterRefs:
      - kubeapi-filter
      - ocp-multicluster-labels

  filters:
    - name: kubeapi-filter
      type: kubeAPIAudit
      kubeAPIAudit:
        # Don't generate audit events for all requests in RequestReceived stage.
        omitStages:
          - "RequestReceived"

    - name: ocp-multicluster-labels
      type: openshiftLabels
      openshiftLabels:
        cluster_name: '{{ fromClusterClaim "name" }}'
