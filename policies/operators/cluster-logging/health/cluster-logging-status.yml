---
apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: cluster-logging-status
spec:
  remediationAction: inform
  severity: high
  object-templates-raw: |
    {{/* ##  Ensure the collector is deployed to all nodes ## */}}
    {{- $nodeCount := (len (lookup "v1" "Node" "" "").items) }}
    - complianceType: musthave
      objectDefinition:
        kind: DaemonSet
        apiVersion: apps/v1
        metadata:
          name: collector
          namespace: openshift-logging
        status:
          currentNumberScheduled: {{ $nodeCount }}
          numberMisscheduled: 0
          desiredNumberScheduled: {{ $nodeCount }}
          numberReady: {{ $nodeCount }}
          updatedNumberScheduled: {{ $nodeCount }}
          numberAvailable: {{ $nodeCount }}

    - complianceType: musthave
      objectDefinition:
        kind: ConfigMap
        apiVersion: v1
        metadata:
          name: collector
          namespace: default
        data:

    {{- $clf := (lookup "observability.openshift.io/v1" "ClusterLogForwarder" "openshift-logging" "collector") }}
          clf: |
            {{ $clf }}
    {{- $pNames := list "" }}
    {{- $iRefs := list "" }}
    {{- $oRefs := list "" }}
    {{- range $pl := $clf.spec.pipelines }}
      {{- range $or := $pl.outputRefs }}
        {{- range $ir := $pl.inputRefs }}


          {{- if not (has $ir $iRefs) }}
            {{- $iRefs = append $iRefs $ir }}
          {{- end }}
          
          {{- $oRefName := printf "%s-%s" $or $ir }}
          {{- if not (has $oRefName $oRefs) }}
            {{- $oRefs = append $oRefs $oRefName }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    - complianceType: musthave
      objectDefinition:
        apiVersion: observability.openshift.io/v1
        kind: ClusterLogForwarder
        metadata:
          name: collector
          namespace: openshift-logging
        status:
          conditions:
          - reason: ClusterRolesExist
            status: "True"
            type: observability.openshift.io/Authorized
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/Valid
          - reason: ReconciliationComplete
            status: "True"
            type: Ready
          filterConditions:
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidFilter-detectexception
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidFilter-parse-json


          inputConditions:
          {{- range $ic := (slice $iRefs 1) }}
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidInput-{{ $ic }}
          {{- end }}

          outputConditions:
          {{- range $oc := (slice $oRefs 1) }}
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidOutput-{{ $oc }}
          {{- end }}

          pipelineConditions:
          {{- range $pc := (slice $pNames 1) }}
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidPipeline-{{ $pc }}
          {{- end }}

