---
apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: cluster-logging-status
spec:
  remediationAction: inform
  severity: high
  object-templates-raw: |
    {{/* ##  Ensure the collector is deployed to all nodes ## */}}
    {{- $nodeCount := (len (lookup "v1" "Node" "" "").items) }}
    - complianceType: musthave
      objectDefinition:
        kind: DaemonSet
        apiVersion: apps/v1
        metadata:
          name: collector
          namespace: openshift-logging
        status:
          currentNumberScheduled: {{ $nodeCount }}
          numberMisscheduled: 0
          desiredNumberScheduled: {{ $nodeCount }}
          numberReady: {{ $nodeCount }}
          updatedNumberScheduled: {{ $nodeCount }}
          numberAvailable: {{ $nodeCount }}

    {{- $clf := (lookup "observability.openshift.io/v1" "ClusterLogForwarder" "openshift-logging" "collector") }}

    {{- $pNames := list "" }}
    {{- $iRefs := list "" }}
    {{- $oRefs := list "" }}
    {{- $fRefs := list "" }}
    {{- range $pl := $clf.spec.pipelines }}
      {{- $pNames = append $pNames (printf "%s%s" $pl.name ((eq (len $pNames) 1) | ternary "" (printf "-%v" (sub (len $pNames) 1)))) }}

      {{- range $fr := $pl.filterRefs }}
        {{- if not (has $fr $fRefs) }}
          {{- $fRefs = append $fRefs $fr }}
        {{- end }}
      {{- end }}

      {{- range $or := $pl.outputRefs }}
        {{- range $ir := $pl.inputRefs }}

          {{- if not (has $ir $iRefs) }}
            {{- $iRefs = append $iRefs $ir }}
          {{- end }}
          
          {{- $oRefName := printf "%s-%s" $or $ir }}
          {{- if not (has $oRefName $oRefs) }}
            {{- $oRefs = append $oRefs $oRefName }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    - complianceType: musthave
      objectDefinition:
        apiVersion: observability.openshift.io/v1
        kind: ClusterLogForwarder
        metadata:
          name: collector
          namespace: openshift-logging
        status:
          conditions:
          - reason: ClusterRolesExist
            status: "True"
            type: observability.openshift.io/Authorized
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/Valid
          - reason: ReconciliationComplete
            status: "True"
            type: Ready


          inputConditions:
          {{- range $ic := (slice $iRefs 1) }}
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidInput-{{ $ic }}
          {{- end }}

          outputConditions:
          {{- range $oc := (slice $oRefs 1) }}
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidOutput-{{ $oc }}
          {{- end }}

          pipelineConditions:
          {{- range $pc := (slice $pNames 1) }}
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidPipeline-{{ $pc }}
          {{- end }}

        {{- if gt (len $fRefs) 1 }}
          filterConditions:
          {{- range $fc := (slice $fRefs 1) }}
          - reason: ValidationSuccess
            status: "True"
            type: observability.openshift.io/ValidFilter-{{ $fc }}
          {{- end }}
        {{- end }}

