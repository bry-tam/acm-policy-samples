---
apiVersion: policy.open-cluster-management.io/v1
kind: PolicyGenerator
metadata:
  name: gen-policy-sm
policyDefaults:
  namespace: bry-tam-policies
  remediationAction: enforce
  consolidateManifests: false
  policySets:
    - servicemesh-operator

  categories:
    - "CM Configuration Management"
  controls:
    - "CM-2 Baseline Configuration"
  standards:
    - "NIST SP 800-53"

  policyLabels:
    policy_gen.name: servicemesh-operator

  severity: medium

placementBindingDefaults:
  name: "servicemesh-binding"

policies:
  - name: servicemesh-operator
    description: "Install ServiceMesh Operator"
    manifests:
      - path: namespace.yml
        name: mesh-operator-namespace

      - path: operatorpolicy.yml

  - name: servicemesh-controlplane
    description: "Configure ServiceMesh Control Plane including Kiali, Tempo, OpenTelemetry and Console Plugins"
    dependencies:
      - name: "servicemesh-operator"
        compliance: "Compliant"
      - name: "kiali-operator"
        compliance: "Compliant"
      - name: "opentelemetry-operator"
        compliance: "Compliant"
      - name: "tempo-operator"
        compliance: "Compliant"
      - name: odf-operator-status
        compliance: "Compliant"
    manifests:
      - path: controlplane/namespace.yml
        name: istio-namespace

      - path: controlplane/namespace-cni.yml
        name: istio-cni-namespace

      - path: controlplane/istio.yml
        name: istio-default

      - path: controlplane/istiocni.yml
        name: istio-cni

      - path: tracing/namespace.yml
        name: tracing-namespace

      - path: tracing/tempo-tenant-readerbinding.yml
        name: tracing-readerbinding

      - path: tracing/tempo-tenant-readerrole.yml
        name: tracing-readerrole

      - path: tracing/tempo-tenant-writerrole.yml
        name: tracing-writerrole

      - path: tracing/opentelemetrycollector.yml
        name: otel-collector

      - path: tracing/opentelemetry-rolebinding.yml
        name: otel-collector-rolebinding

      - path: tracing/objectbucketclaim.yml
        name: tracing-objectbucket

      - path: tracing/tempo-s3-access-secret.yml
        name: tracing-s3access-secret

      - path: tracing/tempo-s3-bundle-configmap.yml
        name: tracing-s3-ca

      - path: tracing/tempo-s3-tls-secret.yml
        name: tracing-s3-tls-secret

      - path: tracing/tempostack.yml
        name: tracing-ossm-tempostack

      - path: controlplane/kiali-clusterrolebinding.yml
        name: kiali-clusterrolebinding

      - path: controlplane/kiali.yml
        name: kiali

      - path: controlplane/ossmconsole.yml
        name: ossm-console-plugin

      - path: controlplane/podmonitor.yml
        name: istio-proxy-podmonitor

      - path: controlplane/servicemonitor.yml
        name: istiod-monitor

      - path: controlplane/telemetry.yml
        name: istio-telemetry

  #     - path: controlplane/user-workload-access-networkpolicy.yml
  #     - path: controlplane/servicemeshcontrolplane.yml


  - name: servicemesh-ingress
    description: "Configure ServiceMesh IngressGateway"
    dependencies:
      - name: "servicemesh-controlplane"
        compliance: "Compliant"
    manifests:
      - path: ingress/namespace.yml
        name: ossm-namespace

      - path: ingress/deployment.yml
        name: ossm-deployment

      - path: ingress/serviceaccount.yml
        name: ossm-serviceaccount

      - path: ingress/service.yml
        name: ossm-service

      - path: ingress/horizontalpodautoscaler.yml
        name: ossm-hpa

      - path: ingress/networkpolicy.yml
        name: ossm-networkpolicy

      - path: ingress/poddisruptionbudget.yml
        name: ossm-pdb

      - path: ingress/role.yml
        name: ossm-role

      - path: ingress/rolebinding.yml
        name: ossm-rolebinding


  # - name: servicemesh-status
  #   remediationAction: InformOnly
  #   # dependencies:
  #   #   - name: "loki-configure"
  #   #     compliance: "Compliant"
  #   manifests:
  #     - path: health/servicemesh-status.yml

policySets:
  - name: servicemesh-operator
    placement:
      placementName: "ft-servicemesh--enabled"
