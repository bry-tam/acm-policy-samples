apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: gatekeeper-instance
spec:
  remediationAction: enforce
  severity: low
  object-templates-raw: |
    - complianceType: musthave
      objectDefinition:
        {{- $infraCount := (len (lookup "v1" "Node" "" "" "node-role.kubernetes.io/infra").items) }}

        apiVersion: operator.gatekeeper.sh/v1alpha1
        kind: Gatekeeper
        metadata:
          name: gatekeeper
        spec:
          audit:
            replicas: {{ ($infraCount | default 2) | toInt }}
            logLevel: DEBUG
            auditInterval: 10s
            constraintViolationLimit: 55
            auditFromCache: Enabled
            auditChunkSize: 66
            emitAuditEvents: Enabled
            resources:
              limits:
                cpu: 500m
                memory: 150Mi
              requests:
                cpu: 500m
                memory: 130Mi
          validatingWebhook: Enabled
          mutatingWebhook: Enabled
          webhook:
            replicas: {{ ($infraCount | default 2) | toInt }}
            emitAdmissionEvents: Enabled
            logLevel: ERROR
            failurePolicy: Fail
            resources:
              limits:
                cpu: 480m
                memory: 140Mi
              requests:
                cpu: 400m
                memory: 120Mi
        {{- if ne $infraCount 0 }}
          tolerations:
            - key: node-role.kubernetes.io/infra
              operator: "Exists"
          nodeSelector:
            node-role.kubernetes.io/infra: ""
        {{- end }}