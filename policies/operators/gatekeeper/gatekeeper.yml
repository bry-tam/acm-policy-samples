---
apiVersion: operator.gatekeeper.sh/v1alpha1
kind: Gatekeeper
metadata:
  name: gatekeeper
spec:
  audit:
    replicas: '{{ (len (getNodesWithExactRoles "infra").items | default 2) | toInt }}'
    logLevel: DEBUG
    auditInterval: 60s
    constraintViolationLimit: 55
    auditFromCache: Enabled
    auditChunkSize: 66
    emitAuditEvents: Enabled
    resources:
      limits:
        cpu: 500m
        memory: 3Gi
      requests:
        cpu: 500m
        memory: 1Gi
  validatingWebhook: Enabled
  mutatingWebhook: Enabled
  webhook:
    replicas: '{{ (len (getNodesWithExactRoles "infra").items | default 2) | toInt }}'
    emitAdmissionEvents: Enabled
    logLevel: DEBUG
    failurePolicy: Ignore
    resources:
      limits:
        cpu: 480m
        memory: 3Gi
      requests:
        cpu: 400m
        memory: 1Gi
  tolerations:
    - key: node-role.kubernetes.io/infra
      operator: "Exists"
  nodeSelector:
    node-role.kubernetes.io/{{ hasNodesWithExactRoles "infra" | ternary "infra" "worker" }}: ""
