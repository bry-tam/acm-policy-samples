---
apiVersion: policy.open-cluster-management.io/v1
kind: PolicyGenerator
metadata:
  name: gen-policy-generator-acs
policyDefaults:
  namespace: bry-tam-policies
  remediationAction: enforce
  consolidateManifests: false
  evaluationInterval:
    compliant: 30s
    noncompliant: 10s
  policySets:
    - acs-operator-hub

  categories:
    - "CM Configuration Management"
  controls:
    - "CM-2 Baseline Configuration"
  standards:
    - "NIST SP 800-53"

  policyLabels:
    policy_gen.name: acs-operator

  severity: medium

placementBindingDefaults:
  name: "acs-operator-binding"

policies:
  - name: acs-operator
    description: "Installs and managed ACS Operator"
    remediationAction: enforce
    policySets:
      - acs-operator-hub
      - acs-operator-managed
    manifests:
      - path: ns-rhacs-operator.yml
        name: acs-operator-namespace

      - path: ns-stackrox.yml
        name: stackrox-namespace

      - path: operatorpolicy.yml


  - name: acs-central
    description: "Configures the Central component of ACS along with reporting health status of Central"
    remediationAction: enforce
    policySets:
      - acs-operator-hub
    dependencies:
      - name: acs-operator
        compliance: "Compliant"
    manifests:
      - path: central/central.yml
        name: stackrox-central-services

      - path: central/consolelink.yml
        name: acs-consolelink

      - path: health/central/central-status.yml
        name: acs-central-status
        remediationAction: InformOnly
        severity: high
        extraDependencies:
          - name: stackrox-central-services
            kind: ConfigurationPolicy
            compliance: "Compliant"


  - name: acs-central-init-bundle
    description: "Configures Job to generate init-bundle"
    remediationAction: enforce
    policySets:
      - acs-operator-hub
    dependencies:
      - name: acs-central
        compliance: "Compliant"
    manifests:
      - path: central/init-bundle/serviceaccount.yml
        name: create-cluster-init-serviceaccount

      - path: central/init-bundle/role.yml
        name: create-cluster-init-role

      - path: central/init-bundle/rolebinding.yml
        name: create-cluster-init-rolebinding

      - path: central/init-bundle/job.yml
        name: create-cluster-init-job
        extraDependencies:
          - name: create-cluster-init-serviceaccount
            kind: ConfigurationPolicy
            compliance: "Compliant"
          - name: create-cluster-init-role
            kind: ConfigurationPolicy
            compliance: "Compliant"
          - name: create-cluster-init-rolebinding
            kind: ConfigurationPolicy
            compliance: "Compliant"


  - name: acs-central-init-bundle-cert
    description: "Configures ACS hub SecuredCluster and CertificatePolicy for init-bundle expiration"
    remediationAction: enforce
    policySets:
      - acs-operator-hub
    dependencies:
      - name: acs-central-init-bundle
        compliance: "Compliant"
    manifests:
      - path: health/central/init-bundle/sensor-tls-cert.yml
        name: acs-bundle-certificates

      - path: central/init-bundle/expired-sensor-tls.yml
        remediationAction: InformOnly
        name: acs-cert-sensor-tls

      - path: sensor/securedcluster.yml
        extraDependencies:
          - name: acs-cert-sensor-tls
            kind: ConfigurationPolicy
            compliance: "Compliant"


  - name: acs-central-expired-certs
    description: "When init-bundle is expired policy removes expired secrets and resets init-bundle job to create a new init-bundle."
    remediationAction: enforce
    complianceType: mustnothave
    policySets:
      - acs-operator-hub
    dependencies:
      - name: acs-central-init-bundle-cert
        compliance: "NonCompliant"
    ## ignorePending prevents the NotCompliant dependency from causing this policy to always report as pending
    ignorePending: true
    manifests:
      - path: central/init-bundle/expired-admission-control-tls.yml
        name: expired-admission-control-tls

      - path: central/init-bundle/expired-collector-tls.yml
        name: expired-collector-tls

      - path: central/init-bundle/expired-sensor-tls.yml
        name: expired-sensor-tls

      - path: central/init-bundle/job.yml
        name: expired-init-bundle-job
        extraDependencies:
          - name: expired-admission-control-tls
            kind: ConfigurationPolicy
            compliance: "Compliant"
          - name: expired-collector-tls
            kind: ConfigurationPolicy
            compliance: "Compliant"
          - name: expired-sensor-tls
            kind: ConfigurationPolicy
            compliance: "Compliant"


  - name: acs-sensor-sync-certs
    description: "Syncs ACS init-bundle secrets to policy namespace"
    remediationAction: enforce
    policySets:
      - acs-operator-hub
    dependencies:
      - name: acs-central-init-bundle-cert
        compliance: "Compliant"
    manifests:
      - path: sensor/sensor-sync-tls-certs.yml
        name: sensor-sync-tls-certs

  - name: acs-sensor
    description: "Propagate init-bundle secrets to managed cluster and create SecuredCluster"
    remediationAction: enforce
    policySets:
      - acs-operator-managed
    manifests:
      - path: sensor/propagate-admission-control-tls.yml
        name: propagate-admission-control-tls

      - path: sensor/propagate-collector-tls.yml
        name: propagate-collector-tls

      - path: sensor/propagate-sensor-tls.yml
        name: propagate-sensor-tls

      - path: sensor/securedcluster.yml
        name: managed-securedcluster
        extraDependencies:
          - name: propagate-admission-control-tls
            kind: ConfigurationPolicy
            compliance: "Compliant"
          - name: propagate-collector-tls
            kind: ConfigurationPolicy
            compliance: "Compliant"
          - name: propagate-sensor-tls
            kind: ConfigurationPolicy
            compliance: "Compliant"

policySets:
  - name: acs-operator-hub
    placement:
      placementName: "ft-acs--hub"

  - name: acs-operator-managed
    placement:
      placementName: "ft-acs--managed"
